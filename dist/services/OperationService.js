import{Builder as e}from"../Builder.js";import{isFalseable as r}from"./FalseableService.js";export function joinOperations(e,r,t){let n=[];for(let t of e)t.length>0&&(n.length>0&&n.push(r),n.push(...t));return t?["(",...n,")"]:n}export function operation(t){if("string"==typeof t){if("*"===t)return["*"];if(t.includes(".")){let[e,r]=t.split(".",2);return[...operation(e),".",...operation(r||"*")]}let e=t.replaceAll(/[\\`]/g,"");return[`\`${e}\``]}if(t instanceof e)return t.getOperations();switch(t.type){case"=":case"!=":case">":case">=":case"<":case"<=":return[...operation(t.sideA),` ${t.type} `,...operation(t.sideB)];case"IDENTIFIER":return void 0===t.alias?operation(t.identifier):[...operation(t.identifier)," AS ",...operation(t.alias)];case"EXCLUDED":return["`excluded`.",...operation(t.identifier)];case"AND":case"OR":{let e=[];for(let n of t.expressions)if(!r(n)){let t=operation(n);r(t)||e.push(t)}return joinOperations(e,` ${t.type} `,e.length>1&&!1!==t.includeParens)}case"VALUE":if("string"==typeof t.argument||"number"==typeof t.argument)return[{value:t.argument}];if("boolean"==typeof t.argument)return[{value:Number(t.argument)}];return[{value:null}];case"IS NULL":return[...operation(t.identifier)," IS NULL"];case"LIKE":case"MATCH":return[...operation(t.identifier)," ",t.type," ",...operation(t.expression)];case"BETWEEN":return[...operation(t.identifier)," BETWEEN ",...operation(t.from)," AND ",...operation(t.to)];case"COLLATE":return[...operation(t.expression),` COLLATE ${t.collate}`];case"CAST":return["CAST(",...operation(t.expression),` AS ${t.cast})`];case"RAW":return[t.expression];case"JSON":return[{value:JSON.stringify(t.argument)}];case"STATIC":return null===t.argument?["NULL"]:!0===t.argument?["TRUE"]:!1===t.argument?["FALSE"]:"number"==typeof t.argument||"bigint"==typeof t.argument?[t.argument.toString()]:[`"${t.argument.replaceAll('"','""')}"`];case"CALL":return[t.identifier,...joinOperations(t.functionArguments.map(e=>operation(e)),", ",!0)];case"NOT":return["NOT ",...operation(t.expression)];case"EXISTS":return["EXISTS ( ",...operation(t.builder),")"];case"SET":return[...operation(t.identifier)," = ",...operation(t.expression)];default:return["(",...operation(t.expressionA),` ${t.operator} `,...operation(t.expressionB),")"]}}